"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[46157],{28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(96540);const s={},o=r.createContext(s);function i(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:t},e.children)}},39068:(e,t,n)=>{n.d(t,{A:()=>o});n(96540);var r=n(27143),s=n(74848);function o(e){let{title:t}=e;return(0,s.jsx)(r.A,{children:(0,s.jsx)("title",{children:t})})}},92873:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"python/developer/how-to/tests","title":"Tests","description":"This section provides an in-depth look at the Quality Assurance (QA) process in the Open Data Platform. It covers the use of QA tools for testing extensions, creation of unit and integration tests, and the importance of maintaining a short import time for the package.","source":"@site/content/python/developer/how-to/tests.mdx","sourceDirName":"python/developer/how-to","slug":"/python/developer/how-to/tests","permalink":"/python/developer/how-to/tests","draft":false,"unlisted":false,"editUrl":"https://github.com/OpenBB-finance/openbb-docs/edit/main/content/python/developer/how-to/tests.mdx","tags":[],"version":"current","lastUpdatedBy":"DidierRLopes","lastUpdatedAt":1761133924000,"sidebarPosition":7,"frontMatter":{"title":"Tests","sidebar_position":7,"description":"This section provides an in-depth look at the Quality Assurance (QA) process in the Open Data Platform. It covers the use of QA tools for testing extensions, creation of unit and integration tests, and the importance of maintaining a short import time for the package.","keywords":["OpenBB QA process","Unit and integration tests","QA tools","Extension testing","Import time optimization"]},"sidebar":"tutorialSidebar","previous":{"title":"Deprecating Endpoints","permalink":"/python/developer/how-to/deprecating_endpoints"},"next":{"title":"Data and Data Providers","permalink":"/python/faqs/data_providers"}}');var s=n(74848),o=n(28453),i=n(39068);const a={title:"Tests",sidebar_position:7,description:"This section provides an in-depth look at the Quality Assurance (QA) process in the Open Data Platform. It covers the use of QA tools for testing extensions, creation of unit and integration tests, and the importance of maintaining a short import time for the package.",keywords:["OpenBB QA process","Unit and integration tests","QA tools","Extension testing","Import time optimization"]},l=void 0,c={},d=[{value:"Dev Tools",id:"dev-tools",level:2},{value:"Built-In Test",id:"built-in-test",level:2},{value:"Unit Tests",id:"unit-tests",level:2},{value:"Repository Scripts &amp; Integration Tests",id:"repository-scripts--integration-tests",level:2},{value:"Integration tests",id:"integration-tests",level:2},{value:"Import time",id:"import-time",level:2},{value:"Known caveats",id:"known-caveats",level:2}];function p(e){const t={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components},{Details:n}=t;return n||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.A,{title:"Tests - Contributor Guidelines - Development | OpenBB Docs"}),"\n",(0,s.jsx)(t.p,{children:"There are a set of QA tools that you can use to test your work."}),"\n",(0,s.jsx)(t.h2,{id:"dev-tools",children:"Dev Tools"}),"\n",(0,s.jsx)(t.p,{children:"Install the developer toolkit packages from PyPI:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sh",children:"pip install openbb-devtools\n"})}),"\n",(0,s.jsxs)(t.p,{children:["This includes ",(0,s.jsx)(t.code,{children:"pytest"})," and the extensions used for capturing unit test cassettes for replay."]}),"\n",(0,s.jsx)(t.h2,{id:"built-in-test",children:"Built-In Test"}),"\n",(0,s.jsxs)(t.p,{children:["Each ",(0,s.jsx)(t.code,{children:"Fetcher"})," comes equipped with a ",(0,s.jsx)(t.code,{children:"test"})," method that will ensure it is implemented correctly, that it is returning the expected data, that all types are correct, and that the data is valid."]}),"\n",(0,s.jsxs)(t.p,{children:["You can run the testing pattern by initializing your Fetcher and running the ",(0,s.jsx)(t.code,{children:".test"})," method,\npassing ",(0,s.jsx)(t.code,{children:"parameters"})," and ",(0,s.jsx)(t.code,{children:"credentials"})," dictionaries."]}),"\n",(0,s.jsxs)(t.p,{children:["A successful test will return ",(0,s.jsx)(t.code,{children:"None"})]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'>>> from openbb_imf.models.port_volume import ImfPortVolumeFetcher\n\n>>> fetcher = ImfPortVolumeFetcher()\n\n>>>fetcher.test({}, {})\n\n# Returns nothing because default values allow no parameters to be passed, and credentials are not required.\n\nfetcher.test({"country": "bad_country"}, {})  # Fails with error.\n'})}),"\n",(0,s.jsxs)(n,{children:[(0,s.jsx)("summary",{mdxType:"summary",children:"Error Message"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\nCell In[12], line 1\n----\x3e 1 fetcher.test({"country": "bad_country"}, {})\n\nFile ~/github/OpenBB/openbb_platform/core/openbb_core/provider/abstract/fetcher.py:141, in Fetcher.test(cls, params, credentials, **kwargs)\n    138 # pylint: disable=import-outside-toplevel\n    139 from pandas import DataFrame\n--\x3e 141 query = cls.transform_query(params=params)\n    142 data = run_async(\n    143     cls.extract_data, query=query, credentials=credentials, **kwargs\n    144 )\n    145 result = cls.transform_data(query=query, data=data, **kwargs)\n\nFile ~/github/OpenBB/openbb_platform/providers/imf/openbb_imf/models/port_volume.py:393, in ImfPortVolumeFetcher.transform_query(params)\n    383     raise OpenBBError(\n    384         ValueError(\n    385             "start_date must be after 2019-01-01 for IMF Port Volume data."\n    386         )\n    387     )\n    389 if country := params.pop("country", None):\n    390     params["port_code"] = (\n    391         params["port_code"]\n    392         if params.get("port_code")\n--\x3e 393         else get_port_ids_by_country(country)\n    394     )\n    396 return ImfPortVolumeQueryParams(**params)\n\nFile ~/github/OpenBB/openbb_platform/providers/imf/openbb_imf/utils/port_watch_helpers.py:61, in get_port_ids_by_country(country_code)\n     58     port_ids_by_country = json.load(file)\n     60 if country_code.upper() not in port_ids_by_country:\n---\x3e 61     raise ValueError(\n     62         f"Country code \'{country_code}\' is not supported by IMF Port Watch."\n     63     )\n     65 return port_ids_by_country.get(country_code.upper(), "")\n\nValueError: Country code \'bad_country\' is not supported by IMF Port Watch.\n'})})]}),"\n",(0,s.jsx)(t.h2,{id:"unit-tests",children:"Unit Tests"}),"\n",(0,s.jsxs)(t.p,{children:["Creating unit tests with mock data can be time consuming, so we use ",(0,s.jsx)(t.code,{children:"vcrpy"})," in conjunction with our own set of ",(0,s.jsx)(t.code,{children:"pytest"})," plugins published as, ",(0,s.jsx)(t.code,{children:"pytest_recorder"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"The plugins capture the HTTP interactions as a YML cassette and replays it while running tests."}),"\n",(0,s.jsx)(t.p,{children:"Record with:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sh",children:"pytest test_some_file.py::test_imf_port_volume_fetcher --record http\n"})}),"\n",(0,s.jsxs)(n,{children:[(0,s.jsx)("summary",{mdxType:"summary",children:"Example Code"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'"""IMF Fetcher Tests."""\n\nfrom datetime import date\n\nimport pytest\nfrom openbb_core.app.service.user_service import UserService\nfrom openbb_imf.models.port_volume import ImfPortVolumeFetcher\n\ntest_credentials = UserService().default_user_settings.credentials.model_dump(\n    mode="json"\n)\n\n@pytest.fixture(scope="module")\ndef vcr_config():\n    """VCR configuration."""\n    return {\n        "filter_headers": [("User-Agent", None)],\n    }\n\n@pytest.mark.record_http\ndef test_imf_port_volume_fetcher(credentials=test_credentials):\n    """Test the ImfPortVolume fetcher."""\n    params = {\n        "port_code": "port1201",\n        "start_date": date(year=2023, month=1, day=1),\n        "end_date": date(year=2023, month=1, day=31),\n    }\n\n    fetcher = ImfPortVolumeFetcher()\n    result = fetcher.test(params, credentials)\n    assert result is None\n'})})]}),"\n",(0,s.jsx)(t.h2,{id:"repository-scripts--integration-tests",children:"Repository Scripts & Integration Tests"}),"\n",(0,s.jsx)(t.p,{children:"Automatic unit test generation will add unit tests for all the fetchers available in a given provider.\nRun the script from the root of the repository."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"python openbb_platform/providers/tests/utils/unit_tests_generator.py\n"})}),"\n",(0,s.jsx)(t.p,{children:"To record the unit tests, you can run the following command:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"pytest <path_to_the_unit_test_file> --record=all\n"})}),"\n",(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsx)(t.p,{children:"Sometimes manual intervention is needed. For example, adjusting out-of-top level imports or adding specific arguments for a given fetcher."})}),"\n",(0,s.jsx)(t.h2,{id:"integration-tests",children:"Integration tests"}),"\n",(0,s.jsx)(t.p,{children:"The integration tests are a bit more complex than the unit tests, as we want to test both the Python interface and the API interface.\nFor this, we have two scripts that will help you generate the integration tests."}),"\n",(0,s.jsx)(t.p,{children:"To generate the integration tests for the Python interface, you can run the following command:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"python openbb_platform/extensions/tests/utils/integration_tests_generator.py\n"})}),"\n",(0,s.jsx)(t.p,{children:"To generate the integration tests for the API interface, you can run the following command:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"python openbb_platform/extensions/tests/utils/integration_tests_api_generator.py\n"})}),"\n",(0,s.jsx)(t.p,{children:"When testing the API interface, you'll need to start a server locally before running the tests. To do so, run the following command:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"uvicorn openbb_core.api.rest_api:app --host 0.0.0.0 --port 8000 --reload\n"})}),"\n",(0,s.jsx)(t.p,{children:"These automated tests are a great way to reduce the amount of code you need to write,\nbut they are not a replacement for manual testing and might require tweaking."}),"\n",(0,s.jsx)(t.p,{children:"To run the tests we can do:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Unit tests only:"}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'pytest openbb_platform -m "not integration"\n'})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Integration tests only:"}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"pytest openbb_platform -m integration\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Both integration and unit tests:"}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"pytest openbb_platform\n"})}),"\n",(0,s.jsx)(t.h2,{id:"import-time",children:"Import time"}),"\n",(0,s.jsxs)(t.p,{children:["We aim to have a short import time for the package. To measure that we use ",(0,s.jsx)(t.code,{children:"tuna"}),"."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://pypi.org/project/tuna/",children:"https://pypi.org/project/tuna/"})}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["To visualize the import time breakdown by module and find potential bottlenecks, run the\nfollowing commands from ",(0,s.jsx)(t.code,{children:"openbb_platform"})," directory:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"pip install tuna\npython -X importtime openbb/__init__.py 2> import.log\ntuna import.log\n"})}),"\n",(0,s.jsx)(t.h2,{id:"known-caveats",children:"Known caveats"}),"\n",(0,s.jsx)(t.p,{children:"When using the OpenBB QA Framework it is important to be aware of the following caveats:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"The tests are semi-automated and might require manual intervention. For example, adjusting out-of-top level imports or changing specific arguments for a given payload."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"The integration tests are more complex and if your newly added provider integration is already covered by the\nintegration tests from previous commands or providers, you will need to manually inject the payload for the new\nprovider."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"In the integration test parametrized payload, the first item is always the set of standard parameters. Every\nconsecutive item is a set of parameters for a specific provider with the standard parameters included."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["The integration tests require you to be explicit, by using all of the standard parameters and provider-specific\nparameters in the payload. If you want to exclude a parameter, you can use ",(0,s.jsx)(t.code,{children:"None"})," as its value."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["The integration tests require you to be explicit by specifying the ",(0,s.jsx)(t.code,{children:"provider"})," parameter in provider-specific\npayloads."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"When recording unit tests, you might run into issues with the cache that is tied to your specific provider and present\non your local machine. You will know that this is the case if your tests pass locally, but fail on the CI. To fix this,\nyou can delete the cache file from your local machine and re-record the tests."}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsxs)(t.p,{children:["Note that the cache is likely located here:\nWindows: ",(0,s.jsx)(t.code,{children:"C:\\Users\\user\\AppData\\Local\\"}),"\nLinux: ",(0,s.jsx)(t.code,{children:"/home/user/.cache/"}),"\nMac: ",(0,s.jsx)(t.code,{children:"/Users/user/Library/Caches"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Some providers (we are aware only of YFinance so far) do an additional request when used from the US region. As our CI\nis running from the US region, this might cause the tests to fail. A workaround for this is to use a VPN to record the\ntests from a different region."}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}}}]);